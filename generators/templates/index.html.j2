{% extends "base.html.j2" %}

{% block title %}lacuene &mdash; Grant Gap Finder{% endblock %}

{% block head_extra %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
{% endblock %}

{% block body %}
<div class="header">
  <div style="display:flex;justify-content:space-between;align-items:flex-start">
    <div>
      <h1><span>lacuene</span> Grant Gap Finder</h1>
      <div class="subtitle">
        Cross-referencing {{ total }} neural crest genes across {{ source_count }} biomedical databases to surface
        clinically important but scientifically understudied genes for NIDCR funding decisions.
      </div>
    </div>
    <a href="about.html" class="about-link">About &amp; Methodology</a>
  </div>
</div>

<div class="container" id="main" role="main">

  <!-- Three query cards -->
  <div class="query-grid">

    <!-- Card 1: Funding Gaps -->
    <div class="query-card">
      <h3>Where are the funding gaps?</h3>
      <div class="qc-desc">
        Genes with OMIM disease association but no FaceBase experimental data.
        These represent known disease genes lacking craniofacial research coverage.
      </div>
      <div class="qc-metric" style="color:var(--red)">{{ critical_count }}</div>
      <div style="font-size:0.8rem;color:var(--text-sec);margin-bottom:1rem">critical gaps out of {{ total }} genes</div>
      <div id="gap-list" style="max-height:300px;overflow-y:auto"></div>
    </div>

    <!-- Card 2: Source Coverage -->
    <div class="query-card">
      <h3>How complete is the data?</h3>
      <div class="qc-desc">
        Coverage across {{ source_count }} biomedical databases. Gaps in FaceBase
        and ClinVar represent opportunities for experimental and clinical research.
      </div>
      {% for key, label in source_names.items() %}
      {% set count = source_counts[key] %}
      {% set pct = (count * 100 // total) if total else 0 %}
      {% if pct >= 90 %}
        {% set bar_color = "var(--green)" %}
      {% elif pct >= 50 %}
        {% set bar_color = "var(--orange)" %}
      {% else %}
        {% set bar_color = "var(--red)" %}
      {% endif %}
      {% set url = source_urls.get(key, "#") %}
      <div class="source-card">
        <a href="{{ url }}" target="_blank" class="source-name">{{ label }}</a>
        <div class="source-bar-bg"><div class="source-bar" style="width:{{ pct }}%;background:{{ bar_color }}"></div></div>
        <div class="source-stat">{{ count }}/{{ total }} ({{ pct }}%)</div>
      </div>
      {% endfor %}
    </div>

    <!-- Card 3: Understudied genes -->
    <div class="query-card">
      <h3>Which genes are understudied?</h3>
      <div class="qc-desc">
        Disease genes ranked by craniofacial publication count (ascending).
        Fewer publications = less research attention relative to clinical importance.
      </div>
      <div id="understudied-list" style="max-height:350px;overflow-y:auto"></div>
    </div>

  </div>

  <!-- Cross-Source Filter -->
  <div class="filter-section" id="filter-section">
    <h2>Cross-Source Filter</h2>
    <div class="filter-desc">Click a source to cycle: <span style="color:var(--text-sec)">any</span> &rarr; <span style="color:var(--green)">required</span> &rarr; <span style="color:var(--red)">excluded</span>. Set numeric ranges. Apply to filter the gene table below.</div>
    <div class="filter-grid">
      {% for key, label in source_names.items() %}
      <button class="filter-toggle" data-filter="{{ filter_keys[key] }}" data-state="any" onclick="cycleFilter(this)" role="switch" aria-checked="false" aria-label="Filter: {{ label }} — any">{{ label }}</button>
      {% endfor %}
    </div>
    <div class="filter-ranges">
      <div class="filter-range-group">
        <label>Pubs min</label>
        <input type="number" id="filter-pub-min" min="0" placeholder="0">
      </div>
      <div class="filter-range-group">
        <label>Pubs max</label>
        <input type="number" id="filter-pub-max" min="0" placeholder="any">
      </div>
      <div class="filter-range-group">
        <label>Pathogenic min</label>
        <input type="number" id="filter-path-min" min="0" placeholder="0">
      </div>
      <div class="filter-range-group">
        <label>Pathogenic max</label>
        <input type="number" id="filter-path-max" min="0" placeholder="any">
      </div>
    </div>
    <div class="filter-actions">
      <button class="action-btn" onclick="applyFilter()" style="background:var(--accent);color:var(--bg);border-color:var(--accent)">Apply to Table</button>
      <button class="action-btn" onclick="resetFilter()">Reset</button>
      <span class="filter-count" id="filter-count"></span>
    </div>
  </div>

  <!-- Graph -->
  <div class="graph-section">
    <div class="graph-header">
      <div>
        <h2>Gene Landscape</h2>
        <div class="gh-sub">Node size = publication count &middot; Color = developmental role &middot; 4 edge types: phenotype, syndrome, pathway, PPI</div>
      </div>
      <div class="graph-controls">
        <div class="control-group">
          <label>Layout:</label>
          <button class="layout-btn active" onclick="setLayout('cose', this)" title="Physics simulation — groups connected genes together">Force</button>
          <button class="layout-btn" onclick="setLayout('circle', this)" title="All genes in a circle — good for seeing all nodes equally">Circle</button>
          <button class="layout-btn" onclick="setLayout('concentric', this)" title="Rings by publication count — most-studied genes at center">Concentric</button>
          <button class="layout-btn" onclick="setClusterLayout(this)" title="Community detection — groups genes by shared connections">Cluster</button>
        </div>
        <div class="control-group">
          <label>Edges:</label>
          <button class="layout-btn edge-filter" data-edge="all" onclick="filterEdges('all', this)" title="Show all edge types (may be visually dense)">All</button>
          <button class="layout-btn edge-filter active" data-edge="key" onclick="filterEdges('key', this)" title="Syndrome + PPI edges only (recommended)">Key</button>
          <button class="layout-btn edge-filter" data-edge="shared_syndrome" onclick="filterEdges('shared_syndrome', this)" title="Genes sharing a Mendelian syndrome">Syndrome</button>
          <button class="layout-btn edge-filter" data-edge="ppi" onclick="filterEdges('ppi', this)" title="Protein-protein interactions from STRING">PPI</button>
          <button class="layout-btn edge-filter" data-edge="shared_pathway" onclick="filterEdges('shared_pathway', this)" title="Genes sharing a GO biological pathway">Pathway</button>
          <button class="layout-btn edge-filter" data-edge="shared_phenotype" onclick="filterEdges('shared_phenotype', this)" title="Genes sharing HPO phenotype terms">Phenotype</button>
        </div>
      </div>
      <div class="graph-legend">
        {% for role, info in legend_items %}
        <span><span class="legend-dot" style="background:{{ info.color }}"></span>{{ info.label }}</span>
        {% endfor %}
      </div>
    </div>
    <div id="cy"></div>
    <div class="community-panel" id="community-info"></div>
  </div>

  <!-- Syndrome-Centric View -->
  <div class="table-section" id="syndrome-section">
    <div class="table-header">
      <h2>Syndrome-Centric View</h2>
      <div class="table-actions">
        <button class="action-btn" id="syndrome-toggle-btn" onclick="toggleSingleGeneSyndromes()">Show All</button>
      </div>
    </div>
    <div class="syndrome-filter-info" id="syndrome-filter-info"></div>
    <div class="table-wrap">
    <table id="syndrome-table">
      <thead>
        <tr>
          <th data-sort-syn="name" data-type="str">Syndrome</th>
          <th data-sort-syn="gene_count" data-type="num">Genes</th>
          <th data-sort-syn="fb_pct" data-type="num">FaceBase %</th>
          <th data-sort-syn="avg_pubs" data-type="num">Avg Pubs</th>
          <th data-sort-syn="pathogenic" data-type="num">Pathogenic</th>
        </tr>
      </thead>
      <tbody id="syndrome-tbody"></tbody>
      <tbody id="syndrome-tbody-single" class="collapsible-section"></tbody>
    </table>
    </div>
  </div>

  <!-- Funding Intelligence -->
  <div class="table-section" id="funding-intel-section">
    <div class="table-header">
      <h2>Funding Intelligence</h2>
    </div>
    <div style="padding:1.5rem">
      <div style="font-size:0.8rem;color:var(--text-sec);margin-bottom:1rem;line-height:1.5">
        Cross-referencing NIH Reporter grants with publication data to identify funding
        misalignments: genes with organic research momentum but no NIH support, and
        genes with active grants but declining output.
      </div>
      <div class="funding-intel-grid">
        <div class="funding-intel-card">
          <h4 style="color:var(--green);margin-bottom:0.5rem">Unfunded Momentum</h4>
          <div style="font-size:0.75rem;color:var(--text-sec);margin-bottom:0.8rem">High recent publications, zero NIH grants</div>
          <div id="unfunded-momentum-list" style="max-height:280px;overflow-y:auto"></div>
        </div>
        <div class="funding-intel-card">
          <h4 style="color:var(--orange);margin-bottom:0.5rem">Funded but Quiet</h4>
          <div style="font-size:0.75rem;color:var(--text-sec);margin-bottom:0.8rem">Active grants but &lt;3 recent publications</div>
          <div id="funded-quiet-list" style="max-height:280px;overflow-y:auto"></div>
        </div>
        <div class="funding-intel-card">
          <h4 style="color:var(--red);margin-bottom:0.5rem">Emerging Hotspots</h4>
          <div style="font-size:0.75rem;color:var(--text-sec);margin-bottom:0.8rem">Research surging + disease-relevant + no funding = invest now</div>
          <div id="hotspot-list" style="max-height:280px;overflow-y:auto"></div>
        </div>
      </div>
      <div style="margin-top:1.2rem">
        <h4 style="color:var(--text);margin-bottom:0.5rem;font-size:0.85rem">Grants vs. Publications</h4>
        <canvas id="funding-scatter" width="800" height="300" style="width:100%;max-width:800px;height:auto;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg)"></canvas>
      </div>
    </div>
  </div>

  <!-- Translational Readiness -->
  <div class="table-section" id="translational-section">
    <div class="table-header">
      <h2>Translational Readiness</h2>
    </div>
    <div style="padding:1.5rem">
      <div style="font-size:0.8rem;color:var(--text-sec);margin-bottom:1rem;line-height:1.5">
        Composite score ranking genes by proximity to clinical translation:
        pathogenic variants (ClinVar) + clinical trials + genetic constraint (pLI) +
        craniofacial expression (GTEx) + disease association (OMIM).
      </div>
      <div id="translational-bars" style="max-height:500px;overflow-y:auto"></div>
    </div>
  </div>

  <!-- Portfolio Overlay -->
  <div class="table-section" id="portfolio-section">
    <div class="table-header">
      <h2>Portfolio Overlay</h2>
    </div>
    <div style="padding:1.5rem">
      <div style="font-size:0.8rem;color:var(--text-sec);margin-bottom:0.8rem;line-height:1.4">
        Paste your funded gene targets to see which critical gaps they cover
        and which remain unfunded.
      </div>
      <textarea id="portfolio-input" class="portfolio-input" placeholder="Paste gene symbols (comma, space, or newline separated)&#10;Example: SOX10, PAX3, TWIST1"></textarea>
      <button class="action-btn" onclick="analyzePortfolio()" style="margin-top:0.5rem">Analyze Portfolio</button>
      <div id="portfolio-results"></div>
    </div>
  </div>

  <!-- Change History -->
  <div class="table-section" id="history-section">
    <div class="table-header">
      <h2>Change History</h2>
    </div>
    <div style="padding:1.5rem" id="history-content"></div>
  </div>

  <!-- Cross-Source Anomalies -->
  <div class="table-section" id="anomalies-section">
    <div class="table-header" style="cursor:pointer" onclick="toggleAnomalies()">
      <h2>Cross-Source Anomalies</h2>
      <div class="table-actions">
        <span class="anomaly-summary-badge" id="anomaly-count-badge"></span>
        <button class="action-btn" id="anomaly-toggle-btn">Expand</button>
      </div>
    </div>
    <div class="anomalies-body collapsible-section" id="anomalies-body">
      <div class="anomalies-type-bar" id="anomalies-type-bar"></div>
      <div class="anomalies-list" id="anomalies-list"></div>
    </div>
  </div>

  <!-- Gene table -->
  <div class="table-section" id="gene-table-section">
    <div class="table-header">
      <h2>Per-Gene Coverage ({{ total }} genes)</h2>
      <input type="text" id="gene-search" class="gene-search-input" placeholder="Search genes, syndromes, proteins..." autocomplete="off">
      <div class="table-actions">
        <button class="action-btn" onclick="showBriefing()">Briefing Summary</button>
        <div class="export-dropdown">
          <button class="action-btn" onclick="toggleExportMenu()">Export CSV &#9662;</button>
          <div class="export-menu" id="export-menu">
            <div class="export-option" onclick="downloadCSV()">All Genes</div>
            <div class="export-option" onclick="downloadCSV('gaps')">Critical Gaps Only</div>
            <div class="export-option" onclick="downloadCSV('priority')">Top Priority (Score &ge;15)</div>
            <div class="export-option" onclick="downloadCSV('understudied')">Understudied (&lt; 20 pubs)</div>
          </div>
        </div>
      </div>
    </div>
    <div class="table-wrap">
    <table role="grid" aria-label="Gene source coverage">
      <thead role="rowgroup">
        <tr role="row">
          <th role="columnheader" data-sort="symbol" data-type="str">Gene</th>
          {% for key, label in source_names.items() %}
          <th data-sort="{{ filter_keys[key] }}" data-type="bool">{{ label }}</th>
          {% endfor %}
          <th data-sort="count" data-type="num">Src</th>
          <th data-sort="pub_total" data-type="num">Pubs</th>
          <th data-sort="pub_recent" data-type="num">Recent</th>
          <th data-sort="pathogenic" data-type="num">Pathogenic</th>
          <th data-sort="syndrome" data-type="str">Key Syndrome</th>
        </tr>
      </thead>
      <tbody id="gene-tbody"></tbody>
    </table>
    </div>
  </div>

  <div class="footer">
    lacuene &mdash; CUE lattice unification for multi-source biomedical data &middot;
    <a href="https://github.com/mtthdn/lacuene">GitHub</a>
  </div>

</div>

<!-- Detail panel -->
<div class="detail-panel" id="detail-panel">
  <button class="detail-close" onclick="closeDetail()" aria-label="Close detail panel">&times;</button>
  <div id="detail-content"></div>
</div>

<!-- Gene Comparison Tray -->
<div class="compare-tray" id="compare-tray">
  <span class="compare-tray-label">Compare:</span>
  <div id="compare-chips"></div>
  <button class="action-btn" onclick="openComparison()" style="background:var(--accent);color:var(--bg);border-color:var(--accent);padding:4px 12px;font-size:0.75rem">Compare</button>
  <button class="action-btn" onclick="clearComparison()" style="padding:4px 8px;font-size:0.75rem">Clear</button>
</div>

<!-- Gene Comparison Modal -->
<div class="compare-modal" id="compare-modal">
  <div class="compare-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
      <h3>Gene Comparison</h3>
      <button class="action-btn" onclick="closeComparison()">Close</button>
    </div>
    <div id="compare-body"></div>
  </div>
</div>

<!-- Edge tooltip -->
<div class="edge-tooltip" id="edge-tooltip"></div>

<!-- Briefing modal -->
<div class="modal-overlay" id="briefing-modal">
  <div class="modal-content">
    <h3>Briefing Summary</h3>
    <pre id="briefing-text"></pre>
    <div class="modal-actions">
      <button class="action-btn" onclick="copyBriefing()">Copy to Clipboard</button>
      <button class="action-btn" onclick="closeBriefing()">Close</button>
    </div>
  </div>
</div>

<script>
{% include "app.js" %}
</script>
{% endblock %}