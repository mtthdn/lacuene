#!/usr/bin/env python3
"""
Normalizer: gnomAD -> model/gnomad.cue

Queries the gnomAD GraphQL API for each of the 95 neural crest genes,
extracting constraint metrics: pLI, LOEUF (oe_lof_upper), and oe_lof.

Results are cached in data/gnomad/gnomad_cache.json for reproducibility.

Usage:
    python3 normalizers/from_gnomad.py
"""

import json
import sys
import time
from pathlib import Path

# Resolve paths relative to repo root (parent of normalizers/)
REPO_ROOT = Path(__file__).resolve().parent.parent
sys.path.insert(0, str(REPO_ROOT / "normalizers"))

from genes import GENES
from pipeline import PipelineReport, escape_cue_string
from utils import post_json_with_retry

CACHE_DIR = REPO_ROOT / "data" / "gnomad"
CACHE_FILE = CACHE_DIR / "gnomad_cache.json"
OUTPUT_FILE = REPO_ROOT / "model" / "gnomad.cue"

GNOMAD_API_URL = "https://gnomad.broadinstitute.org/api"

REQUEST_DELAY = 0.5  # seconds between requests

QUERY_TEMPLATE = """
{
  gene(gene_symbol: "%s", reference_genome: GRCh38) {
    gene_id
    gnomad_constraint {
      pLI
      oe_lof
      oe_lof_upper
    }
  }
}
"""


def fetch_gnomad_gene(symbol: str) -> dict | None:
    """
    Query gnomAD GraphQL API for a gene symbol. Returns dict with:
      - gene_id: Ensembl gene ID (e.g. ENSG00000125398)
      - pli: pLI score (probability of LoF intolerance)
      - oe_lof: observed/expected ratio for LoF variants
      - loeuf: LOEUF (oe_lof upper bound confidence interval)
    Or None on failure.
    """
    query = QUERY_TEMPLATE % symbol

    try:
        data = post_json_with_retry(
            GNOMAD_API_URL,
            json_body={"query": query},
            headers={"Accept": "application/json"},
        )
    except Exception as e:
        print(f"  WARNING: request failed for {symbol}: {e}", file=sys.stderr)
        return None

    gene = data.get("data", {}).get("gene")
    if gene is None:
        return None

    gene_id = gene.get("gene_id", "")
    constraint = gene.get("gnomad_constraint") or {}

    pli = constraint.get("pLI")
    oe_lof = constraint.get("oe_lof")
    loeuf = constraint.get("oe_lof_upper")

    # All constraint values may be None if gnomAD has no data for this gene
    return {
        "gene_id": gene_id,
        "pli": pli,
        "oe_lof": oe_lof,
        "loeuf": loeuf,
    }


def load_cache() -> dict:
    """Load cached gnomAD data if available."""
    if CACHE_FILE.exists():
        with open(CACHE_FILE) as f:
            return json.load(f)
    return {}


def save_cache(cache: dict) -> None:
    """Persist the gnomAD cache to disk."""
    CACHE_DIR.mkdir(parents=True, exist_ok=True)
    with open(CACHE_FILE, "w") as f:
        json.dump(cache, f, indent=2, sort_keys=True)
    print(f"  cached: {CACHE_FILE}")


def format_score(value) -> str:
    """Format a numeric score for CUE output, or return empty string if None."""
    if value is None:
        return None
    # Round to reasonable precision
    return f"{float(value):.4g}"


def generate_cue(gnomad_data: dict) -> str:
    """Generate CUE source from gnomAD data, keyed by HGNC symbol."""
    gene_count = len(gnomad_data)
    lines = [
        "package froq",
        "",
        "// gnomAD: gene constraint metrics for neural crest genes.",
        "// Source: gnomAD GraphQL API (GRCh38)",
        f"// Generated by normalizers/from_gnomad.py -- {gene_count} genes",
        "",
        "genes: {",
    ]

    for symbol in sorted(gnomad_data.keys()):
        entry = gnomad_data[symbol]
        gene_id = escape_cue_string(entry.get("gene_id", ""))

        lines.append(f'\t"{symbol}": {{')
        lines.append(f"\t\t_in_gnomad: true")
        lines.append(f'\t\tgnomad_id:  "{gene_id}"')

        pli = format_score(entry.get("pli"))
        loeuf = format_score(entry.get("loeuf"))
        oe_lof = format_score(entry.get("oe_lof"))

        if pli is not None:
            lines.append(f"\t\tpli_score:  {pli}")
        if loeuf is not None:
            lines.append(f"\t\tloeuf_score: {loeuf}")
        if oe_lof is not None:
            lines.append(f"\t\toe_lof:     {oe_lof}")

        lines.append(f"\t}}")

    lines.append("}")
    lines.append("")  # trailing newline

    return "\n".join(lines)


def main():
    report = PipelineReport("from_gnomad")
    print("from_gnomad: querying gnomAD for neural crest gene constraint metrics...")

    cache = load_cache()
    gnomad_data = {}
    fetched = 0
    cached_count = 0
    failed = 0

    for symbol in sorted(GENES.keys()):
        if symbol in cache:
            entry = cache[symbol]
            pli = entry.get("pli")
            pli_str = f"pLI={pli:.3f}" if pli is not None else "no constraint"
            print(f"  {symbol}: cached ({pli_str})")
            gnomad_data[symbol] = entry
            report.cached(symbol, pli_str)
            cached_count += 1
            continue

        print(f"  {symbol}: querying gnomAD...", end=" ", flush=True)
        result = fetch_gnomad_gene(symbol)
        time.sleep(REQUEST_DELAY)

        if result is None:
            print(f"FAILED (skipping)", file=sys.stderr)
            report.failed(symbol, "API returned no data")
            failed += 1
            continue

        pli = result.get("pli")
        pli_str = f"pLI={pli:.3f}" if pli is not None else "no constraint"
        loeuf = result.get("loeuf")
        loeuf_str = f"LOEUF={loeuf:.3f}" if loeuf is not None else "n/a"
        print(f"{pli_str}, {loeuf_str}")

        gnomad_data[symbol] = result
        cache[symbol] = result
        report.ok(symbol, f"{pli_str}, {loeuf_str}")
        fetched += 1

    # Save updated cache
    save_cache(cache)

    if not gnomad_data:
        print("ERROR: no gnomAD data retrieved for any gene", file=sys.stderr)
        sys.exit(1)

    # Write CUE output
    print("from_gnomad: writing model/gnomad.cue...")
    cue_source = generate_cue(gnomad_data)
    OUTPUT_FILE.parent.mkdir(parents=True, exist_ok=True)
    with open(OUTPUT_FILE, "w") as f:
        f.write(cue_source)

    # Stats
    has_pli = sum(1 for d in gnomad_data.values() if d.get("pli") is not None)
    has_loeuf = sum(1 for d in gnomad_data.values() if d.get("loeuf") is not None)

    print(f"from_gnomad: wrote {OUTPUT_FILE}")
    print(f"  {len(gnomad_data)} genes, {has_pli} with pLI, {has_loeuf} with LOEUF")
    print(f"  ({fetched} fetched, {cached_count} cached, {failed} failed)")
    print(report.summary())


if __name__ == "__main__":
    main()
